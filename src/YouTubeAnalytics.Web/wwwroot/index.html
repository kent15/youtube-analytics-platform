<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube Analytics Tool</title>
  <style>
    /* ===== Reset & Base ===== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --primary-light: #e0e7ff;
      --bg: #f8fafc;
      --surface: #ffffff;
      --text: #1e293b;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --radius: 12px;
      --shadow: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,.08), 0 4px 6px -4px rgba(0,0,0,.04);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ===== Header ===== */
    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      text-decoration: none;
    }

    .header-logo svg { flex-shrink: 0; }

    .header-nav { display: flex; gap: 8px; }

    .nav-item {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      border: none;
      background: none;
      transition: all .15s;
    }

    .nav-item:hover { background: var(--bg); color: var(--text); }
    .nav-item.active { background: var(--primary-light); color: var(--primary); }
    .nav-item.disabled { opacity: .4; cursor: not-allowed; }

    .header-quota {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .quota-bar {
      width: 100px;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }

    .quota-fill {
      height: 100%;
      width: 0%;
      background: var(--success);
      border-radius: 3px;
      transition: width .5s;
    }

    /* ===== Main Layout ===== */
    .main { max-width: 1120px; margin: 0 auto; padding: 32px 24px; }

    /* ===== Screens ===== */
    .screen { display: none; }
    .screen.active { display: block; }

    /* ===== Search Screen ===== */
    .hero { text-align: center; padding: 64px 0 48px; }

    .hero h1 { font-size: 32px; font-weight: 800; margin-bottom: 12px; }

    .hero p {
      font-size: 16px;
      color: var(--text-secondary);
      max-width: 480px;
      margin: 0 auto 40px;
    }

    .search-box {
      display: flex;
      gap: 12px;
      max-width: 560px;
      margin: 0 auto;
    }

    .search-input {
      flex: 1;
      padding: 14px 20px;
      font-size: 15px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      outline: none;
      transition: border-color .15s;
      background: var(--surface);
    }

    .search-input:focus { border-color: var(--primary); }
    .search-input::placeholder { color: #94a3b8; }

    .btn {
      padding: 14px 28px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all .15s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: var(--shadow-lg); }

    .btn-secondary {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover { background: var(--bg); }

    .sample-channels {
      margin-top: 32px;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .sample-chip {
      padding: 8px 16px;
      font-size: 13px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      cursor: pointer;
      transition: all .15s;
      color: var(--text-secondary);
    }

    .sample-chip:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }

    /* ===== Loading Screen ===== */
    .loading-container { text-align: center; padding: 120px 0; }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 24px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-steps {
      max-width: 400px;
      margin: 32px auto 0;
      text-align: left;
    }

    .loading-step {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .loading-step.done { color: var(--success); }
    .loading-step.active { color: var(--text); font-weight: 500; }

    .step-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }

    .step-icon.pending { background: var(--border); }
    .step-icon.done { background: var(--success); color: #fff; }
    .step-icon.active { background: var(--primary); color: #fff; animation: pulse 1.5s infinite; }

    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .6; } }

    /* ===== Result Screen ===== */
    .result-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 32px;
    }

    .channel-profile { display: flex; align-items: center; gap: 20px; }

    .channel-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), #a78bfa);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
      color: #fff;
    }

    .channel-name { font-size: 24px; font-weight: 700; }

    .channel-id {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 2px;
      font-family: monospace;
    }

    /* Cards grid */
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 32px; }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      transition: all .2s;
    }

    .card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }

    .card-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: var(--text-secondary);
      font-weight: 600;
      margin-bottom: 8px;
    }

    .card-value { font-size: 28px; font-weight: 800; }
    .card-sub { font-size: 13px; color: var(--text-secondary); margin-top: 4px; }

    /* Judgement section */
    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .judgement-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .judgement-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }

    .judgement-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .judgement-icon.growing { background: #d1fae5; }
    .judgement-icon.stable  { background: #e0e7ff; }
    .judgement-icon.viral   { background: #fef3c7; }

    .judgement-label { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
    .judgement-value { font-size: 18px; font-weight: 700; margin: 4px 0; }
    .judgement-desc { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }

    /* Badge */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-success { background: #d1fae5; color: #065f46; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-info    { background: #e0e7ff; color: #3730a3; }
    .badge-danger  { background: #fee2e2; color: #991b1b; }

    /* Video table */
    .table-container {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .table-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
    }

    .table-title { font-size: 16px; font-weight: 700; }

    table { width: 100%; border-collapse: collapse; }

    thead th {
      padding: 12px 16px;
      text-align: left;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: var(--text-secondary);
      font-weight: 600;
      background: #f8fafc;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    thead th:hover { color: var(--text); }
    thead th.sorted { color: var(--primary); }

    tbody td {
      padding: 14px 16px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
    }

    tbody tr { transition: background .1s; }
    tbody tr:hover { background: #f8fafc; }
    tbody tr:last-child td { border-bottom: none; }

    .video-title-cell { max-width: 300px; }

    .video-title-text {
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: block;
    }

    .video-date { font-size: 12px; color: var(--text-secondary); }
    .num { text-align: right; font-variant-numeric: tabular-nums; }
    .sort-arrow { font-size: 10px; margin-left: 4px; }

    /* ===== Error Screen ===== */
    .error-container { text-align: center; padding: 100px 0; }

    .error-icon {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: #fee2e2;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 28px;
    }

    .error-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }

    .error-message {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 24px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    /* ===== Toast ===== */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--text);
      color: #fff;
      padding: 14px 24px;
      border-radius: var(--radius);
      font-size: 14px;
      box-shadow: var(--shadow-lg);
      transform: translateY(80px);
      opacity: 0;
      transition: all .3s;
      z-index: 200;
    }

    .toast.show { transform: translateY(0); opacity: 1; }

    /* ===== Trend Graph Section ===== */
    .graph-section { margin-bottom: 32px; }

    .graph-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .period-tabs {
      display: flex;
      gap: 4px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 3px;
    }

    .period-tab {
      padding: 6px 16px;
      font-size: 13px;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all .15s;
    }

    .period-tab:hover { color: var(--text); }
    .period-tab.active { background: var(--surface); color: var(--primary); box-shadow: var(--shadow); }

    .graph-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .graph-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }

    .graph-card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .chart-wrap { position: relative; height: 220px; }

    .chart-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 220px;
      color: var(--text-secondary);
      font-size: 14px;
      gap: 8px;
    }

    .chart-empty-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    @media (max-width: 768px) {
      .graph-grid { grid-template-columns: 1fr; }
      .graph-section-header { flex-direction: column; gap: 12px; align-items: flex-start; }
    }

    /* ===== Responsive ===== */
    @media (max-width: 640px) {
      .header { padding: 12px 16px; }
      .header-nav { display: none; }
      .main { padding: 20px 16px; }
      .hero { padding: 40px 0 32px; }
      .hero h1 { font-size: 24px; }
      .search-box { flex-direction: column; }
      .cards { grid-template-columns: 1fr 1fr; }
      .judgement-grid { grid-template-columns: 1fr; }
      .result-header { flex-direction: column; gap: 16px; }
    }
  </style>
</head>
<body>

  <!-- ===== Header ===== -->
  <header class="header">
    <a class="header-logo" href="#" onclick="showScreen('search')">
      <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
        <rect width="28" height="28" rx="8" fill="#6366f1"/>
        <path d="M11 8l8 6-8 6V8z" fill="#fff"/>
      </svg>
      YouTube Analytics
    </a>

    <nav class="header-nav">
      <button class="nav-item active" id="nav-analysis" onclick="showScreen('search')">
        チャンネル分析
      </button>
      <button class="nav-item disabled" title="フェーズ2で実装予定">
        動画ランキング
      </button>
      <button class="nav-item disabled" title="フェーズ3で実装予定">
        伸び率分析
      </button>
      <button class="nav-item disabled" title="フェーズ4で実装予定">
        競合比較
      </button>
    </nav>

    <div class="header-quota">
      <span>Quota:</span>
      <div class="quota-bar"><div class="quota-fill" id="quotaFill"></div></div>
      <span id="quotaText">-- / 10,000</span>
    </div>
  </header>

  <main class="main">

    <!-- ===== Screen: Search ===== -->
    <section class="screen active" id="screen-search">
      <div class="hero">
        <h1>YouTubeチャンネルを分析</h1>
        <p>チャンネルIDを入力するだけで、成長傾向・投稿パターン・バズ依存度を分析します。</p>

        <div class="search-box">
          <input
            type="text"
            class="search-input"
            id="channelInput"
            placeholder="チャンネルID（例: UCxxxxxxxxxxxxxxxxxxxxxx）"
            spellcheck="false"
          >
          <button class="btn btn-primary" id="btnAnalyze" onclick="startAnalysis()">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M11.742 10.344a6.5 6.5 0 10-1.397 1.398l3.85 3.85a1 1 0 001.415-1.415l-3.85-3.85zm-5.242.156a5 5 0 110-10 5 5 0 010 10z"/>
            </svg>
            分析開始
          </button>
        </div>

        <div class="sample-channels">
          <span style="font-size:13px;color:var(--text-secondary);margin-right:4px;">サンプル:</span>
          <button class="sample-chip" onclick="fillChannel('UCftwRNsjfRo08xYE31tkiyw')">WIRED</button>
          <button class="sample-chip" onclick="fillChannel('UC_x5XG1OV2P6uZZ5FSM9Ttw')">Google Developers</button>
          <button class="sample-chip" onclick="fillChannel('UCZf__ehlCEBPop-_sldpBUQ')">HikakinTV</button>
        </div>
      </div>
    </section>

    <!-- ===== Screen: Loading ===== -->
    <section class="screen" id="screen-loading">
      <div class="loading-container">
        <div class="spinner"></div>
        <h2 style="font-size:20px;font-weight:700;margin-bottom:4px;">分析中...</h2>
        <p style="font-size:14px;color:var(--text-secondary);" id="loadingChannelName"></p>

        <div class="loading-steps" id="loadingSteps">
          <div class="loading-step" data-step="0">
            <span class="step-icon pending"></span>
            チャンネル基本情報を取得中
          </div>
          <div class="loading-step" data-step="1">
            <span class="step-icon pending"></span>
            動画一覧を取得中
          </div>
          <div class="loading-step" data-step="2">
            <span class="step-icon pending"></span>
            動画の詳細統計を取得中
          </div>
          <div class="loading-step" data-step="3">
            <span class="step-icon pending"></span>
            分析結果を算出中
          </div>
        </div>
      </div>
    </section>

    <!-- ===== Screen: Result ===== -->
    <section class="screen" id="screen-result">

      <!-- Channel header -->
      <div class="result-header">
        <div class="channel-profile">
          <div class="channel-avatar" id="resultAvatar">?</div>
          <div>
            <div class="channel-name" id="resultName"></div>
            <div class="channel-id" id="resultId"></div>
          </div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-secondary" onclick="showScreen('search')">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor"><path d="M6 1a5 5 0 014.383 7.39l2.814 2.813a.75.75 0 01-1.06 1.06L9.323 8.45A5 5 0 116 1zm0 1.5a3.5 3.5 0 100 7 3.5 3.5 0 000-7z"/></svg>
            別のチャンネル
          </button>
          <button class="btn btn-secondary" onclick="reAnalyze()">
            再分析
          </button>
        </div>
      </div>

      <!-- Basic info cards -->
      <div class="cards">
        <div class="card">
          <div class="card-label">登録者数</div>
          <div class="card-value" id="statSubs">-</div>
          <div class="card-sub">チャンネル登録者</div>
        </div>
        <div class="card">
          <div class="card-label">総再生回数</div>
          <div class="card-value" id="statViews">-</div>
          <div class="card-sub">全動画の累計</div>
        </div>
        <div class="card">
          <div class="card-label">動画本数</div>
          <div class="card-value" id="statVideoCount">-</div>
          <div class="card-sub">公開動画</div>
        </div>
        <div class="card">
          <div class="card-label">直近30日の投稿数</div>
          <div class="card-value" id="statRecent">-</div>
          <div class="card-sub" id="statRecentSub">-</div>
        </div>
      </div>

      <!-- Aggregated metrics -->
      <div class="cards" style="margin-bottom:32px;">
        <div class="card">
          <div class="card-label">直近投稿の平均再生数</div>
          <div class="card-value" id="statAvgView">-</div>
          <div class="card-sub">直近30日間の投稿動画</div>
        </div>
      </div>

      <!-- Judgement -->
      <div class="section-title">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="var(--primary)">
          <path d="M10 2a8 8 0 100 16 8 8 0 000-16zm1 11H9v-2h2v2zm0-4H9V5h2v4z"/>
        </svg>
        判定結果
      </div>

      <div class="judgement-grid">
        <div class="judgement-card" id="judgementGrowth">
          <div class="judgement-icon growing">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#059669"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L3 15.59 4.41 17l6-6 4 4 6.3-6.29L23 11V3h-8l1 3z"/></svg>
          </div>
          <div>
            <div class="judgement-label">成長傾向</div>
            <div class="judgement-value" id="judgementGrowthValue">-</div>
            <div class="judgement-desc" id="judgementGrowthDesc">-</div>
          </div>
        </div>
        <div class="judgement-card" id="judgementFrequency">
          <div class="judgement-icon stable">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#4f46e5"><path d="M4 15h4v5H4zm6-6h4v11h-4zm6-4h4v15h-4z"/></svg>
          </div>
          <div>
            <div class="judgement-label">投稿頻度</div>
            <div class="judgement-value" id="judgementFrequencyValue">-</div>
            <div class="judgement-desc" id="judgementFrequencyDesc">-</div>
          </div>
        </div>
        <div class="judgement-card" id="judgementViral">
          <div class="judgement-icon viral">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="#d97706"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          </div>
          <div>
            <div class="judgement-label">バズ依存性</div>
            <div class="judgement-value" id="judgementViralValue">-</div>
            <div class="judgement-desc" id="judgementViralDesc">-</div>
          </div>
        </div>
      </div>

      <!-- Trend Graphs -->
      <div class="graph-section" id="graphSection">
        <div class="graph-section-header">
          <div class="section-title" style="margin-bottom:0;">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="var(--primary)">
              <path d="M2 16h16v2H2v-2zm1-1l4-4 3 3 6.5-7L18 8.5V3h-5.5l1.8 1.8L9 10.5 6 7.5l-4 4 1 1z"/>
            </svg>
            推移グラフ
          </div>
          <div class="period-tabs" id="periodTabs">
            <button class="period-tab" data-days="7" onclick="switchPeriod(7)">7日</button>
            <button class="period-tab active" data-days="30" onclick="switchPeriod(30)">30日</button>
            <button class="period-tab" data-days="90" onclick="switchPeriod(90)">90日</button>
          </div>
        </div>

        <div class="graph-grid">
          <div class="graph-card">
            <div class="graph-card-title">登録者数の推移</div>
            <div class="chart-wrap">
              <canvas id="chartSubscribers"></canvas>
            </div>
          </div>
          <div class="graph-card">
            <div class="graph-card-title">総再生回数の推移</div>
            <div class="chart-wrap">
              <canvas id="chartViews"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Video list table -->
      <div class="table-container">
        <div class="table-header">
          <span class="table-title">直近の動画一覧</span>
          <span style="font-size:13px;color:var(--text-secondary);" id="videoCountLabel"></span>
        </div>
        <table>
          <thead>
            <tr>
              <th style="width:40px">#</th>
              <th>タイトル</th>
              <th>公開日</th>
              <th class="num">再生数</th>
              <th class="num">高評価</th>
              <th class="num">コメント</th>
            </tr>
          </thead>
          <tbody id="videoTableBody">
          </tbody>
        </table>
      </div>
    </section>

    <!-- ===== Screen: Error ===== -->
    <section class="screen" id="screen-error">
      <div class="error-container">
        <div class="error-icon">!</div>
        <div class="error-title" id="errorTitle">エラーが発生しました</div>
        <div class="error-message" id="errorMessage"></div>
        <button class="btn btn-primary" onclick="showScreen('search')">検索に戻る</button>
      </div>
    </section>

  </main>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script>
    /* ===== State ===== */
    let chartSubs = null;
    let chartViews = null;
    let currentResult = null;
    let currentPeriod = 30;
    let currentChannelId = '';
    let analysisAbortController = null;

    /* ===== Judgement Display Mappings ===== */
    const GROWTH_MAP = {
      Growing:   { label: '伸びている', badge: 'Growing',   cls: 'badge-success', desc: '直近の再生数がチャンネル平均を上回っており、成長が継続しています。' },
      Stable:    { label: '停滞',       badge: 'Stable',    cls: 'badge-info',    desc: '再生数はチャンネル平均と同水準で推移しています。' },
      Declining: { label: '減少',       badge: 'Declining', cls: 'badge-danger',  desc: '直近の再生数がチャンネル平均を下回っており、減少傾向が見られます。' }
    };

    const FREQUENCY_MAP = {
      High:   { label: '高頻度', badge: 'High',   cls: 'badge-info',    desc: '週3本以上の安定した投稿頻度を維持しています。' },
      Medium: { label: '中頻度', badge: 'Medium', cls: 'badge-info',    desc: '週1〜3本のペースで投稿しています。' },
      Low:    { label: '低頻度', badge: 'Low',    cls: 'badge-warning', desc: '週1本未満の投稿頻度です。' }
    };

    const STRATEGY_MAP = {
      ViralDependent: { label: 'バズ依存型', badge: 'ViralDependent', cls: 'badge-danger',  desc: '上位10%の動画が全体再生数の50%以上を占めています。' },
      Stable:         { label: '安定型',     badge: 'Stable',         cls: 'badge-warning', desc: '再生数が特定動画に偏っておらず、安定したパフォーマンスです。' }
    };

    /* ===== Screen Management ===== */
    function showScreen(name) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById('screen-' + name).classList.add('active');
      if (name === 'search' && analysisAbortController) {
        analysisAbortController.abort();
        analysisAbortController = null;
      }
    }

    /* ===== Fill Channel ===== */
    function fillChannel(id) {
      document.getElementById('channelInput').value = id;
    }

    /* ===== Format Number ===== */
    function formatNumber(n) {
      return Number(n).toLocaleString();
    }

    /* ===== Start Analysis ===== */
    async function startAnalysis() {
      const channelId = document.getElementById('channelInput').value.trim();
      if (!channelId) {
        showToast('チャンネルIDを入力してください');
        return;
      }

      currentChannelId = channelId;

      // Show loading screen
      showScreen('loading');
      document.getElementById('loadingChannelName').textContent = channelId;

      // Reset loading steps
      const steps = document.querySelectorAll('.loading-step');
      steps.forEach(s => {
        s.classList.remove('done', 'active');
        s.querySelector('.step-icon').className = 'step-icon pending';
        s.querySelector('.step-icon').textContent = '';
      });

      // Animate loading steps while waiting for API
      let currentStep = 0;
      const stepInterval = setInterval(() => {
        if (currentStep > 0 && currentStep <= steps.length) {
          const prevStep = steps[currentStep - 1];
          prevStep.classList.remove('active');
          prevStep.classList.add('done');
          prevStep.querySelector('.step-icon').className = 'step-icon done';
          prevStep.querySelector('.step-icon').textContent = '\u2713';
        }
        if (currentStep < steps.length) {
          steps[currentStep].classList.add('active');
          steps[currentStep].querySelector('.step-icon').className = 'step-icon active';
          currentStep++;
        }
      }, 800);

      // Call the API
      analysisAbortController = new AbortController();
      try {
        const response = await fetch('/api/channels/' + encodeURIComponent(channelId) + '/analysis', {
          signal: analysisAbortController.signal
        });

        clearInterval(stepInterval);

        // Mark all steps as done
        steps.forEach(s => {
          s.classList.remove('active');
          s.classList.add('done');
          s.querySelector('.step-icon').className = 'step-icon done';
          s.querySelector('.step-icon').textContent = '\u2713';
        });

        if (response.ok) {
          const data = await response.json();
          currentResult = data;
          await updateQuota();
          setTimeout(() => {
            renderResult(data);
            showScreen('result');
          }, 400);
        } else if (response.status === 404) {
          const err = await response.json();
          setTimeout(() => {
            document.getElementById('errorTitle').textContent = 'チャンネルが見つかりません';
            document.getElementById('errorMessage').textContent =
              'チャンネルID「' + channelId + '」は存在しないか、非公開に設定されています。IDを確認して再度お試しください。';
            showScreen('error');
          }, 400);
        } else if (response.status === 429) {
          setTimeout(() => {
            document.getElementById('errorTitle').textContent = 'API クォータ上限';
            document.getElementById('errorMessage').textContent =
              'YouTube APIの日次クォータ上限に達しました。太平洋時間の午前0時にリセットされます。';
            showScreen('error');
          }, 400);
        } else {
          const err = await response.json().catch(() => ({}));
          setTimeout(() => {
            document.getElementById('errorTitle').textContent = 'エラーが発生しました';
            document.getElementById('errorMessage').textContent =
              err.error || 'サーバーとの通信でエラーが発生しました。しばらく後にお試しください。';
            showScreen('error');
          }, 400);
        }
      } catch (e) {
        clearInterval(stepInterval);
        if (e.name === 'AbortError') return;
        document.getElementById('errorTitle').textContent = '通信エラー';
        document.getElementById('errorMessage').textContent =
          'サーバーに接続できませんでした。サーバーが起動しているか確認してください。';
        showScreen('error');
      } finally {
        analysisAbortController = null;
      }
    }

    /* ===== Re-analyze ===== */
    function reAnalyze() {
      if (currentChannelId) {
        document.getElementById('channelInput').value = currentChannelId;
        startAnalysis();
      }
    }

    /* ===== Render Result ===== */
    function renderResult(data) {
      const ch = data.channel;
      document.getElementById('resultAvatar').textContent = ch.channelName ? ch.channelName.charAt(0).toUpperCase() : '?';
      document.getElementById('resultName').textContent = ch.channelName;
      document.getElementById('resultId').textContent = ch.channelId;
      document.getElementById('statSubs').textContent = formatNumber(ch.subscriberCount);
      document.getElementById('statViews').textContent = formatNumber(ch.totalViewCount);
      document.getElementById('statVideoCount').textContent = formatNumber(ch.videoCount);
      document.getElementById('statRecent').textContent = formatNumber(data.recentVideoCount);

      var avgPerWeek = (data.recentVideoCount / (30 / 7)).toFixed(1);
      document.getElementById('statRecentSub').textContent = '平均 ' + avgPerWeek + '本/週';

      document.getElementById('statAvgView').textContent = formatNumber(Math.round(data.averageViewCount));

      // Judgements
      var g = GROWTH_MAP[data.growthTrend] || GROWTH_MAP.Stable;
      document.getElementById('judgementGrowthValue').innerHTML =
        g.label + ' <span class="badge ' + g.cls + '">' + g.badge + '</span>';
      document.getElementById('judgementGrowthDesc').textContent = g.desc;

      var f = FREQUENCY_MAP[data.publishingFrequency] || FREQUENCY_MAP.Medium;
      document.getElementById('judgementFrequencyValue').innerHTML =
        f.label + ' <span class="badge ' + f.cls + '">' + f.badge + '</span>';
      document.getElementById('judgementFrequencyDesc').textContent = f.desc;

      var s = STRATEGY_MAP[data.contentStrategy] || STRATEGY_MAP.Stable;
      document.getElementById('judgementViralValue').innerHTML =
        s.label + ' <span class="badge ' + s.cls + '">' + s.badge + '</span>';
      document.getElementById('judgementViralDesc').textContent = s.desc;

      // Charts
      var graphSection = document.getElementById('graphSection');
      if (data.snapshots && data.snapshots.length > 1) {
        graphSection.style.display = '';
        currentPeriod = 30;
        document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
        document.querySelector('.period-tab[data-days="30"]').classList.add('active');
        setTimeout(function() { renderCharts(data.snapshots, 30); }, 50);
      } else {
        graphSection.style.display = 'none';
      }

      // Video table
      var videos = data.recentVideos || [];
      document.getElementById('videoCountLabel').textContent = videos.length + '件';
      var tbody = document.getElementById('videoTableBody');
      tbody.innerHTML = '';
      videos.forEach(function(v, i) {
        var tr = document.createElement('tr');
        var dateStr = v.publishedAt ? v.publishedAt.substring(0, 10) : '';
        tr.innerHTML =
          '<td style="color:var(--text-secondary)">' + (i + 1) + '</td>' +
          '<td class="video-title-cell"><span class="video-title-text">' + escapeHtml(v.title) + '</span></td>' +
          '<td class="video-date">' + dateStr + '</td>' +
          '<td class="num">' + formatNumber(v.viewCount) + '</td>' +
          '<td class="num">' + formatNumber(v.likeCount) + '</td>' +
          '<td class="num">' + formatNumber(v.commentCount) + '</td>';
        tbody.appendChild(tr);
      });
    }

    /* ===== Render Charts ===== */
    function renderCharts(snapshots, days) {
      var sliced = snapshots.slice(-(days + 1));
      if (sliced.length < 2) return;

      var labels = sliced.map(function(s) {
        var d = new Date(s.recordedAt);
        return (d.getMonth() + 1) + '/' + d.getDate();
      });

      var commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { intersect: false, mode: 'index' },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1e293b',
            titleFont: { size: 12 },
            bodyFont: { size: 13 },
            padding: 10,
            cornerRadius: 8,
            callbacks: {
              label: function(ctx) { return ctx.parsed.y.toLocaleString(); }
            }
          }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { font: { size: 11 }, color: '#94a3b8', maxTicksLimit: days <= 7 ? 7 : 10 }
          },
          y: {
            grid: { color: '#f1f5f9' },
            ticks: {
              font: { size: 11 },
              color: '#94a3b8',
              callback: function(v) {
                if (v >= 1e9) return (v / 1e9).toFixed(1) + 'B';
                if (v >= 1e6) return (v / 1e6).toFixed(1) + 'M';
                if (v >= 1e3) return (v / 1e3).toFixed(0) + 'K';
                return v;
              }
            }
          }
        },
        elements: {
          point: { radius: days <= 7 ? 4 : days <= 30 ? 2 : 0, hoverRadius: 5 },
          line: { tension: 0.3, borderWidth: 2.5 }
        }
      };

      if (chartSubs) chartSubs.destroy();
      if (chartViews) chartViews.destroy();

      chartSubs = new Chart(document.getElementById('chartSubscribers'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            data: sliced.map(function(s) { return s.subscriberCount; }),
            borderColor: '#6366f1',
            backgroundColor: 'rgba(99,102,241,.08)',
            fill: true
          }]
        },
        options: commonOptions
      });

      chartViews = new Chart(document.getElementById('chartViews'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            data: sliced.map(function(s) { return s.totalViewCount; }),
            borderColor: '#10b981',
            backgroundColor: 'rgba(16,185,129,.08)',
            fill: true
          }]
        },
        options: commonOptions
      });
    }

    /* ===== Switch Period ===== */
    function switchPeriod(days) {
      currentPeriod = days;
      document.querySelectorAll('.period-tab').forEach(function(t) { t.classList.remove('active'); });
      document.querySelector('.period-tab[data-days="' + days + '"]').classList.add('active');
      if (currentResult && currentResult.snapshots) {
        renderCharts(currentResult.snapshots, days);
      }
    }

    /* ===== Quota Update ===== */
    async function updateQuota() {
      try {
        var response = await fetch('/api/quota');
        if (response.ok) {
          var data = await response.json();
          var used = data.limit - data.remaining;
          var pct = Math.round((used / data.limit) * 100);
          var fill = document.getElementById('quotaFill');
          fill.style.width = pct + '%';
          if (pct > 80) {
            fill.style.background = 'var(--danger)';
          } else if (pct > 50) {
            fill.style.background = 'var(--warning)';
          } else {
            fill.style.background = 'var(--success)';
          }
          document.getElementById('quotaText').textContent =
            formatNumber(used) + ' / ' + formatNumber(data.limit);
        }
      } catch (e) {
        // Quota fetch is non-critical
      }
    }

    /* ===== Toast ===== */
    function showToast(msg) {
      var toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(function() { toast.classList.remove('show'); }, 2500);
    }

    /* ===== Escape HTML ===== */
    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /* ===== Enter key support ===== */
    document.getElementById('channelInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') startAnalysis();
    });

    /* ===== Initial quota load ===== */
    updateQuota();
  </script>

</body>
</html>
